{"root":{"data":{"text":"chart部署健康诊断"},"children":[{"data":{"text":"Manager初始化"},"children":[{"data":{"text":"创建Manager实例"},"children":[{"data":{"text":"设置组件名称和命名空间"},"children":[]},{"data":{"text":"注册默认诊断器"},"children":[{"data":{"text":"EventDiagnoser - 事件诊断器"},"children":[]},{"data":{"text":"PodDiagnoser - Pod诊断器"},"children":[]},{"data":{"text":"ResourcesDiagnoser - 资源诊断器"},"children":[]},{"data":{"text":"ServiceDiagnoser - 服务诊断器"},"children":[]}]},{"data":{"text":"资源分类处理"},"children":[{"data":{"text":"调用CategorizeResources方法"},"children":[{"data":{"text":"workload资源分类"},"children":[{"data":{"text":"Pod, Deployment, StatefulSet, DaemonSet, Job, CronJob, ReplicaSet"},"children":[]}]},{"data":{"text":"service资源分类"},"children":[{"data":{"text":"Service"},"children":[]}]},{"data":{"text":"其他资源忽略"},"children":[]}]}]},{"data":{"text":"诊断器初始化"},"children":[{"data":{"text":"遍历所有诊断器"},"children":[{"data":{"text":"调用initializeDiagnoser方法"},"children":[{"data":{"text":"根据RequiredResources分配资源"},"children":[{"data":{"text":"ResourceTypeAll - 分配所有资源"},"children":[]},{"data":{"text":"ResourceTypeWorkload - 分配工作负载资源"},"children":[]},{"data":{"text":"ResourceTypeService - 分配服务资源"},"children":[]},{"data":{"text":"ResourceTypeEvent - 分配事件资源"},"children":[]}]},{"data":{"text":"调用SetDiagnosisStartTime设置开始时间"},"children":[]}]}]},{"data":{"text":"事件获取处理"},"children":[{"data":{"text":"调用fetchEventsIfNeeded方法"},"children":[{"data":{"text":"判断是否需要事件资源"},"children":[{"data":{"text":"shouldProvideEvents检查"},"children":[]}]}]}]}]}]}]},{"data":{"text":"诊断执行阶段"},"children":[{"data":{"text":"Manager.Run方法执行"},"children":[{"data":{"text":"executeDiagnosis方法调用"},"children":[{"data":{"text":"收集异常Pod日志"},"children":[{"data":{"text":"调用collectAbnormalPodLogs"},"children":[{"data":{"text":"遍历工作负载资源中的Pod"},"children":[{"data":{"text":"调用isPodAbnormal判断Pod是否异常"},"children":[{"data":{"text":"检查Pod phase"},"children":[{"data":{"text":"Pending - 等待调度"},"children":[]},{"data":{"text":"Failed - 执行失败"},"children":[]}]},{"data":{"text":"检查容器状态"},"children":[{"data":{"text":"CrashLoopBackOff"},"children":[]},{"data":{"text":"ImagePullBackOff"},"children":[]},{"data":{"text":"Error状态"},"children":[]}]}]},{"data":{"text":"对异常Pod调用collectPodLogs收集日志"},"children":[{"data":{"text":"当前容器日志 - 最后100行"},"children":[]},{"data":{"text":"上一个容器日志 - 最后100行"},"children":[]}]}]}]}]},{"data":{"text":"关联Pod到控制器"},"children":[{"data":{"text":"调用associatePodsToControllers"},"children":[{"data":{"text":"提取控制器信息"},"children":[{"data":{"text":"调用extractControllersFromResources"},"children":[]}]},{"data":{"text":"为每个Pod查找控制器"},"children":[{"data":{"text":"调用findControllerForPod"},"children":[{"data":{"text":"通过OwnerReferences建立关联"},"children":[]},{"data":{"text":"通过标签选择器匹配"},"children":[]}]},{"data":{"text":"建立ControllerInfo映射关系"},"children":[]}]}]}]},{"data":{"text":"执行所有诊断器"},"children":[{"data":{"text":"调用executeDiagnosers"},"children":[{"data":{"text":"遍历所有已初始化的诊断器"},"children":[{"data":{"text":"调用每个诊断器的Diagnose方法"},"children":[]},{"data":{"text":"收集所有诊断结果到resourceDiagnoses列表"},"children":[]}]}]}]}]}]}]},{"data":{"text":"并行诊断执行"},"children":[{"data":{"text":"事件诊断 (EventDiagnoser)"},"children":[{"data":{"text":"EventDiagnoser.Diagnose方法"},"children":[{"data":{"text":"遍历所有事件"},"children":[{"data":{"text":"判断事件类型"},"children":[{"data":{"text":"Normal事件 - 正常"},"children":[]},{"data":{"text":"Warning事件 - 警告"},"children":[]}]},{"data":{"text":"分析事件Reason"},"children":[{"data":{"text":"FailedScheduling"},"children":[{"data":{"text":"Insufficient cpu - cpu不足"},"children":[]},{"data":{"text":"Insufficient memory - memory不足"},"children":[]},{"data":{"text":"node(s) had taints - 节点污点"},"children":[]},{"data":{"text":"didn't match node selector - 节点选择器不匹配"},"children":[]}]},{"data":{"text":"ErrImagePull"},"children":[{"data":{"text":"pulling image失败"},"children":[]},{"data":{"text":"镜像不存在或权限问题"},"children":[]}]},{"data":{"text":"CrashLoopBackOff"},"children":[{"data":{"text":"容器启动后崩溃"},"children":[]},{"data":{"text":"配置错误或代码问题"},"children":[]}]},{"data":{"text":"BackOff"},"children":[{"data":{"text":"退避重试"},"children":[]}]},{"data":{"text":"Pulling"},"children":[{"data":{"text":"正在拉取镜像"},"children":[]}]},{"data":{"text":"FailedMount"},"children":[{"data":{"text":"存储卷挂载失败"},"children":[]}]},{"data":{"text":"NetworkNotReady"},"children":[{"data":{"text":"网络插件问题"},"children":[]}]}]}]}]},{"data":{"text":"生成事件建议"},"children":[{"data":{"text":"GenerateEventRecommendations方法"},"children":[{"data":{"text":"事件原因统计"},"children":[{"data":{"text":"创建reasonCounts映射"},"children":[]},{"data":{"text":"遍历事件列表进行统计"},"children":[]}]},{"data":{"text":"建议生成"},"children":[{"data":{"text":"FailedScheduling + 资源不足 - 增加集群资源"},"children":[]},{"data":{"text":"ImagePullBackOff - 检查镜像名称和仓库权限"},"children":[]},{"data":{"text":"CrashLoopBackOff - 检查容器日志分析崩溃原因"},"children":[]},{"data":{"text":"FailedMount - 检查存储卷配置和权限"},"children":[]},{"data":{"text":"NetworkNotReady - 检查网络插件和配置"},"children":[]}]}]}]}]},{"data":{"text":"Pod诊断 (PodDiagnoser)"},"children":[{"data":{"text":"PodDiagnoser.Diagnose方法"},"children":[{"data":{"text":"Pod提取"},"children":[{"data":{"text":"调用extractPodsFromWorkloads方法"},"children":[{"data":{"text":"从workloadResources中提取所有Pod对象"},"children":[]}]}]},{"data":{"text":"Pod诊断循环"},"children":[{"data":{"text":"遍历提取的Pod列表"},"children":[{"data":{"text":"对每个Pod调用diagnosePod方法"},"children":[{"data":{"text":"收集问题、建议和严重程度信息"},"children":[]}]}]}]}]},{"data":{"text":"diagnosePod方法执行"},"children":[{"data":{"text":"基础状态设置"},"children":[{"data":{"text":"创建PodStatus结构体"},"children":[]},{"data":{"text":"设置Pod名称、阶段、类型"},"children":[]}]},{"data":{"text":"Pod阶段判断"},"children":[{"data":{"text":"Pending状态"},"children":[{"data":{"text":"调用diagnosePendingPodWithRecommendations"},"children":[{"data":{"text":"检查调度状态"},"children":[{"data":{"text":"节点选择器问题"},"children":[]},{"data":{"text":"资源不足"},"children":[]},{"data":{"text":"污点容忍问题"},"children":[]}]},{"data":{"text":"检查初始化容器"},"children":[{"data":{"text":"容器状态Waiting"},"children":[{"data":{"text":"ImagePullBackOff - 镜像拉取失败"},"children":[]},{"data":{"text":"CrashLoopBackOff - 容器启动失败"},"children":[{"data":{"text":"过滤日志关键字"},"children":[{"data":{"text":"\"at least 416k\" - 栈内存不足"},"children":[]},{"data":{"text":"\"OOMKilled\" - 内存溢出"},"children":[]},{"data":{"text":"\"permission denied\" - 权限问题"},"children":[]}]}]},{"data":{"text":"CreateContainerConfigError - 配置错误"},"children":[]}]},{"data":{"text":"容器状态Terminated"},"children":[{"data":{"text":"检查退出码"},"children":[]}]}]},{"data":{"text":"检查存储卷挂载"},"children":[{"data":{"text":"PersistentVolumeClaim问题"},"children":[]}]}]}]},{"data":{"text":"Running状态"},"children":[{"data":{"text":"调用diagnoseRunningPodWithRecommendations"},"children":[{"data":{"text":"检查初始化容器状态"},"children":[{"data":{"text":"ready: true - 正常"},"children":[]},{"data":{"text":"ready: false - 异常"},"children":[{"data":{"text":"获取容器状态和日志"},"children":[]}]}]},{"data":{"text":"检查普通容器状态"},"children":[{"data":{"text":"ready: true - 正常"},"children":[]},{"data":{"text":"ready: false - 异常"},"children":[{"data":{"text":"容器状态分析"},"children":[{"data":{"text":"Waiting状态"},"children":[{"data":{"text":"CrashLoopBackOff"},"children":[{"data":{"text":"过滤日志关键字"},"children":[{"data":{"text":"\"panic:\" - 程序panic"},"children":[]},{"data":{"text":"\"fatal error:\" - 致命错误"},"children":[]}]}]},{"data":{"text":"ImagePullBackOff"},"children":[]},{"data":{"text":"Running状态但not ready"},"children":[{"data":{"text":"就绪探针失败"},"children":[]},{"data":{"text":"存活探针失败"},"children":[]}]}]},{"data":{"text":"Terminated状态"},"children":[{"data":{"text":"检查退出码和原因"},"children":[]}]}]}]}]}]}]},{"data":{"text":"Succeeded状态"},"children":[{"data":{"text":"一般是Job类型"},"children":[]},{"data":{"text":"检查是否正常完成"},"children":[]}]},{"data":{"text":"Failed状态"},"children":[{"data":{"text":"检查失败原因"},"children":[]},{"data":{"text":"分析容器退出码"},"children":[]}]},{"data":{"text":"Unknown状态"},"children":[{"data":{"text":"节点通信问题"},"children":[]},{"data":{"text":"kubelet异常"},"children":[]}]}]},{"data":{"text":"就绪状态计算"},"children":[{"data":{"text":"遍历pod.Status.ContainerStatuses"},"children":[]},{"data":{"text":"统计Ready为true的容器数量"},"children":[]},{"data":{"text":"设置ReadyDetail为\"readyCount/totalCount\"格式"},"children":[]}]},{"data":{"text":"容器诊断"},"children":[{"data":{"text":"调用diagnoseInitContainers诊断初始化容器"},"children":[]},{"data":{"text":"调用diagnoseContainers诊断应用容器"},"children":[]},{"data":{"text":"调用collectErrorLogs收集异常日志"},"children":[]}]}]},{"data":{"text":"日志收集与分析"},"children":[{"data":{"text":"getContainerLogs方法"},"children":[{"data":{"text":"使用k8sClient.CoreV1().Pods().GetLogs()获取日志"},"children":[]},{"data":{"text":"设置TailLines为100行"},"children":[]},{"data":{"text":"支持获取previous日志(重启前的日志)"},"children":[]}]},{"data":{"text":"analyzeContainerLogs方法"},"children":[{"data":{"text":"调用GetLogKeywordPatterns获取关键字模式"},"children":[]},{"data":{"text":"按行分割日志内容"},"children":[]},{"data":{"text":"对每行日志匹配关键字模式"},"children":[{"data":{"text":"Java应用错误: OutOfMemoryError、StackOverflowError等"},"children":[]},{"data":{"text":"数据库连接错误: Connection refused、Access denied等"},"children":[]},{"data":{"text":"网络错误: Network unreachable、Connection reset等"},"children":[]}]}]}]}]},{"data":{"text":"资源诊断 (ResourcesDiagnoser)"},"children":[{"data":{"text":"ResourcesDiagnoser.Diagnose方法"},"children":[{"data":{"text":"资源合并"},"children":[{"data":{"text":"合并workloadResources和serviceResources到allResources"},"children":[]},{"data":{"text":"如果没有资源，返回空诊断结果"},"children":[]}]},{"data":{"text":"资源诊断循环"},"children":[{"data":{"text":"遍历allResources列表"},"children":[]},{"data":{"text":"调用diagnoseResource方法根据资源类型分发诊断"},"children":[]}]}]},{"data":{"text":"具体资源类型诊断"},"children":[{"data":{"text":"diagnoseDeployment方法"},"children":[{"data":{"text":"获取期望副本数(deployment.Spec.Replicas)"},"children":[]},{"data":{"text":"获取就绪副本数(deployment.Status.ReadyReplicas)"},"children":[]},{"data":{"text":"比较副本数判断是否有问题"},"children":[]},{"data":{"text":"如果有关联Pod，调用diagnosePodsByController"},"children":[]}]},{"data":{"text":"diagnoseStatefulSet方法"},"children":[{"data":{"text":"获取期望副本数(statefulSet.Spec.Replicas)"},"children":[]},{"data":{"text":"获取就绪副本数(statefulSet.Status.ReadyReplicas)"},"children":[]},{"data":{"text":"比较副本数判断是否有问题"},"children":[]}]},{"data":{"text":"diagnoseDaemonSet方法"},"children":[{"data":{"text":"获取期望调度数(daemonSet.Status.DesiredNumberScheduled)"},"children":[]},{"data":{"text":"获取就绪数(daemonSet.Status.NumberReady)"},"children":[]},{"data":{"text":"比较数量判断是否有问题"},"children":[]}]},{"data":{"text":"diagnoseJob方法"},"children":[{"data":{"text":"检查job.Status.Succeeded是否大于0(成功)"},"children":[]},{"data":{"text":"检查job.Status.Failed是否大于0(失败)"},"children":[]},{"data":{"text":"否则判断为运行中状态"},"children":[]}]},{"data":{"text":"diagnoseCronJob方法"},"children":[{"data":{"text":"检查cronJob.Status.Active列表长度"},"children":[]},{"data":{"text":"获取cronJob.Status.LastScheduleTime"},"children":[]},{"data":{"text":"设置定时任务状态信息"},"children":[]}]},{"data":{"text":"diagnoseService方法"},"children":[{"data":{"text":"检查service.Spec.Ports列表长度"},"children":[]},{"data":{"text":"判断服务是否暴露端口"},"children":[]},{"data":{"text":"设置服务状态信息"},"children":[]}]}]},{"data":{"text":"Pod关联诊断"},"children":[{"data":{"text":"hasAssociatedPods方法"},"children":[{"data":{"text":"遍历工作负载资源中的Pod"},"children":[]},{"data":{"text":"检查Pod注解中的控制器信息"},"children":[]},{"data":{"text":"检查Pod的OwnerReferences"},"children":[]}]},{"data":{"text":"diagnosePodsByController方法"},"children":[{"data":{"text":"找到属于指定控制器的Pod"},"children":[]},{"data":{"text":"调用diagnoseSinglePod进行详细诊断"},"children":[]},{"data":{"text":"如果有podDiagnoser，临时设置资源并调用其Diagnose方法"},"children":[]}]}]}]},{"data":{"text":"服务诊断 (ServiceDiagnoser)"},"children":[{"data":{"text":"ServiceDiagnoser.Diagnose方法"},"children":[{"data":{"text":"遍历服务资源"},"children":[{"data":{"text":"检查服务类型"},"children":[{"data":{"text":"ClusterIP"},"children":[]},{"data":{"text":"NodePort"},"children":[]},{"data":{"text":"LoadBalancer"},"children":[]},{"data":{"text":"ExternalName"},"children":[]}]},{"data":{"text":"检查端口配置"},"children":[]},{"data":{"text":"检查选择器匹配"},"children":[]}]},{"data":{"text":"生成服务状态和建议"},"children":[]}]}]}]},{"data":{"text":"诊断结果聚合"},"children":[{"data":{"text":"AggregateDiagnosesWithMappings方法"},"children":[{"data":{"text":"初始化聚合结构"},"children":[{"data":{"text":"创建Diagnosis结构体"},"children":[]},{"data":{"text":"初始化各种状态判断变量"},"children":[]},{"data":{"text":"创建Pod控制器映射的快速查找表"},"children":[]}]},{"data":{"text":"资源诊断结果聚合"},"children":[{"data":{"text":"遍历resourceDiags列表"},"children":[]},{"data":{"text":"聚合Summary和Recommendation"},"children":[]},{"data":{"text":"根据ResourceType分类处理Details"},"children":[{"data":{"text":"workload - 添加到Workloads列表，应用Pod控制器映射"},"children":[]},{"data":{"text":"service - 添加到Services列表"},"children":[]},{"data":{"text":"event - 添加到Events列表"},"children":[]}]}]},{"data":{"text":"状态分析与判断"},"children":[{"data":{"text":"analyzeWorkloadStatus方法"},"children":[{"data":{"text":"根据工作负载类型分析状态"},"children":[{"data":{"text":"Job/CronJob - 检查执行成功/失败状态"},"children":[]},{"data":{"text":"其他类型 - 检查运行状态和Pod异常情况"},"children":[]}]}]},{"data":{"text":"analyzeEventStatus方法"},"children":[{"data":{"text":"检查事件类型为Warning的事件"},"children":[]},{"data":{"text":"识别严重错误事件(Failed、FailedCreate、FailedMount)"},"children":[]}]},{"data":{"text":"determineOverallStatus方法"},"children":[{"data":{"text":"状态优先级判断: failed > abnormal > success > normal"},"children":[]}]}]}]}]},{"data":{"text":"结果输出与转换"},"children":[{"data":{"text":"诊断报告生成"},"children":[{"data":{"text":"建议收集和去重"},"children":[{"data":{"text":"RecommendationCollector结构体"},"children":[]},{"data":{"text":"CollectRecommendations方法"},"children":[]}]},{"data":{"text":"结果整合"},"children":[{"data":{"text":"Summaries聚合"},"children":[]},{"data":{"text":"Recommendations聚合"},"children":[]},{"data":{"text":"Workloads聚合"},"children":[]},{"data":{"text":"Services聚合"},"children":[]},{"data":{"text":"Events聚合"},"children":[]}]},{"data":{"text":"报告生成架构"},"children":[{"data":{"text":"ReportBuilder - 报告构建器"},"children":[]},{"data":{"text":"FormatAdapter - 格式适配器"},"children":[]},{"data":{"text":"TemplateEngine - 模板引擎"},"children":[]},{"data":{"text":"Serializer - 序列化器"},"children":[]}]},{"data":{"text":"报告结构设计"},"children":[{"data":{"text":"Diagnosis结构体"},"children":[]},{"data":{"text":"DiagnosisDetails结构体"},"children":[]},{"data":{"text":"DiagnosisMetadata结构体"},"children":[]},{"data":{"text":"Summary结构体"},"children":[]},{"data":{"text":"TrendAnalysis结构体"},"children":[]},{"data":{"text":"Recommendation结构体"},"children":[]},{"data":{"text":"Action结构体"},"children":[]}]},{"data":{"text":"报告构建器实现"},"children":[{"data":{"text":"ReportBuilder结构体"},"children":[]},{"data":{"text":"OutputFormat枚举"},"children":[]},{"data":{"text":"NewReportBuilder方法"},"children":[]},{"data":{"text":"BuildReport方法"},"children":[]}]},{"data":{"text":"格式化器实现"},"children":[{"data":{"text":"Formatter接口"},"children":[]},{"data":{"text":"JSONFormatter实现"},"children":[]},{"data":{"text":"ProtobufFormatter实现"},"children":[]},{"data":{"text":"MarkdownFormatter实现"},"children":[]}]},{"data":{"text":"模板引擎实现"},"children":[{"data":{"text":"TemplateEngine结构体"},"children":[]},{"data":{"text":"NewTemplateEngine方法"},"children":[]},{"data":{"text":"registerTemplateFunctions辅助函数"},"children":[]}]}]}]}]},"template":"default","theme":"fresh-blue","version":"1.4.43"}